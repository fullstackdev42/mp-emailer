version: '3'

dotenv: ['.env']

vars:
  BINARY_NAME: mp-emailer
  GO_FILES: '$(find . -name "*.go" -type f -not -path "./vendor/*")'
  BIN_DIR: bin
  DB_URL: mysql://{{.DB_USER}}:{{.DB_PASSWORD}}@tcp({{.DB_HOST}}:{{.DB_PORT}})/{{.DB_NAME}}
  MIGRATIONS: "{{.MIGRATIONS_PATH}}"

tasks:
  default:
    cmds:
      - task: run

  build:
    desc: Build the application
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - go build -o {{.BIN_DIR}}/{{.BINARY_NAME}} main.go

  run:
    desc: Run the application
    deps: [build]
    cmds:
      - ./{{.BIN_DIR}}/{{.BINARY_NAME}}

  test:
    desc: Run tests
    cmds:
      - go test ./... -v

  lint:
    desc: Lint the code
    cmds:
      - golangci-lint run

  fmt:
    desc: Format the code
    cmds:
      - gofmt -s -w {{.GO_FILES}}

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BIN_DIR}}

  all:
    desc: Run all tasks (lint, test, build)
    cmds:
      - task: lint
      - task: build
      - task: test

  migrate-up:
    desc: Run all up migrations
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} up

  migrate-down:
    desc: Run all down migrations
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} down {{.CLI_ARGS}}

  migrate-up-one:
    desc: Run one up migration
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} up 1

  migrate-down-one:
    desc: Run one down migration
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} down 1

  migrate-force:
    desc: Force set migration version
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} force {{.CLI_ARGS}}

  migrate-version:
    desc: Show current migration version
    cmds:
      - migrate -database "{{.DB_URL}}" -path {{.MIGRATIONS}} version

  mailpit-logs:
    desc: View Mailpit logs
    cmds:
      - docker-compose -f .devcontainer/docker-compose.yml logs -f mailpit

  dev:
    desc: Run the application with live reloading
    cmds:
      - air

  frontend-install:
    desc: Install frontend dependencies
    dir: web
    cmds:
      - npm install

  frontend-build:
    desc: Build frontend assets
    dir: web
    cmds:
      - npm run build

  frontend-dev:
    desc: Run frontend development server
    dir: web
    cmds:
      - npm run dev
    method: none

  dev-sync:
    desc: Run the application with live reloading, frontend assets compilation, and browser sync
    cmds:
      - |
        exec /usr/bin/env bash -c '
        set -x

        PID_FILE="/tmp/dev-sync-pids.txt"
        rm -f "$PID_FILE"
        touch "$PID_FILE"

        cleanup() {
          echo "Shutting down processes..."
          
          # Kill all child processes in their own process group
          kill -TERM -$$
          
          # Clean up PID file
          rm -f "$PID_FILE"
          
          # Force kill any remaining processes
          pkill -KILL -P $$
          
          exit 0
        }

        # Set up process group
        set -m
        
        # Handle both SIGINT and SIGTERM
        trap cleanup INT TERM

        # Start processes in their own process groups
        (cd web && npm run dev) & 
        echo $! >> "$PID_FILE"

        (air) &
        echo $! >> "$PID_FILE"

        (cd web && npx browser-sync start --config bs-config.js) &
        echo $! >> "$PID_FILE"

        wait
        '
    shell: bash
    method: none
